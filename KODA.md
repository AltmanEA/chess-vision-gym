# KODA — Инструкционный контекст проекта

## Обзор проекта

**Название проекта**: Chess Vision Gym (Шахматный тренажер)

**Назначение**: Веб-приложение для тренировки шахматного зрения и решения шахматных задач. Пользователи могут решать различные типы задач (нахождение нужного поля, хода, последовательности ходов), а приложение отслеживает статистику решений и сохраняет все попытки пользователя.

**Текущий статус**: Проект находится в активной разработке. Реализована базовая инфраструктура, отображение шахматной доски, полная система типов для задач и статистики, сервисы для работы с localStorage и React хуки для управления статистикой. UI для решения задач и отображения статистики еще не реализован.

---

## Технологический стек

### Frontend
- **Фреймворк**: React 19 с использованием Vite
- **Язык**: TypeScript (строгий режим включен)
- **Сборщик**: Vite
- **Стили**: CSS (без препроцессоров)

### Основные библиотеки
- **chess.js**: Библиотека для работы с шахматной логикой (валидация ходов, FEN, PGN)
- **react-chessboard**: Компонент для отображения шахматной доски
- **@dnd-kit/core, @dnd-kit/modifiers**: Библиотеки для drag-and-drop функциональности
- **react-dnd, react-dnd-html5-backend**: Альтернативная реализация drag-and-drop

### Хранение данных
- **localStorage**: Основное хранилище для статистики и попыток пользователя
- **Расширяемость**: Архитектура позволяет добавить серверное хранение в будущем

---

## Архитектура

### Трехуровневая архитектура

```
┌─────────────────────────────────────┐
│   Presentation Layer (UI)           │
│   - React компоненты                 │
│   - Хуки состояния                   │
│   - Контекст                         │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│   Business Logic Layer              │
│   - Custom Hooks                     │
│   - Сервисы бизнес-логики           │
│   - Хуки контекста                  │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│   Data Access Layer                 │
│   - Сервисы работы с данными        │
│   - API (будет добавлен)            │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│   Хранилища данных                  │
│   - localStorage                    │
│   - Внешние файлы задач (JSON)      │
└─────────────────────────────────────┘
```

### Структура проекта

```
chess-vision-gym/
├── src/
│   ├── components/          # React компоненты (пока пусто)
│   ├── services/            # Сервисы бизнес-логики
│   │   ├── statsService.ts  # Вычисление статистики
│   │   └── storageService.ts # Работа с localStorage
│   ├── hooks/               # React хуки и провайдеры
│   │   ├── index.ts         # Экспорты хуков
│   │   ├── statisticsContext.ts # Контекст статистики (внутренний)
│   │   ├── StatisticsProvider.tsx # Провайдер статистики
│   │   └── useStatistics.ts # Публичные хуки статистики
│   ├── types/               # TypeScript типы
│   │   ├── puzzle.ts        # Типы для задач
│   │   └── statistics.ts    # Типы для статистики
│   ├── utils/
│   │   ├── fenUtils.ts      # Утилиты для работы с FEN
│   │   └── puzzleUtils.ts   # Утилиты для работы с задачами
│   ├── App.tsx              # Главный компонент приложения
│   ├── App.css              # Стили главного компонента
│   ├── main.tsx             # Точка входа в приложение
│   └── index.css            # Глобальные стили
├── public/                  # Публичные файлы
│   └── puzzles/             # Коллекции задач
│       └── examples.json    # Примеры задач всех типов
├── doc/                     # Документация проекта
│   ├── overview.md          # Обзор проекта
│   ├── plan.md              # План реализации
│   ├── spec.md              # Спецификация приложения
│   ├── puzzle-format.md     # Формат хранения задач
│   └── statistics-format.md # Формат хранения статистики
├── package.json             # Зависимости и скрипты
├── vite.config.ts           # Конфигурация Vite
├── tsconfig.json            # Конфигурация TypeScript
├── tsconfig.app.json        # TypeScript для приложения
├── tsconfig.node.json       # TypeScript для Node.js
└── eslint.config.js         # Конфигурация ESLint
```

---

## Сборка и запуск

### Основные команды

```bash
# Установка зависимостей (при первом запуске)
npm install

# Запуск dev-сервера (http://localhost:5173)
npm run dev

# Сборка для продакшена
npm run build

# Предпросмотр продакшн-сборки
npm run preview

# Проверка кода линтером
npm run lint

# Запуск TypeScript компилятора
npx tsc --noEmit
```

### Зависимости

**Production:**
- `react`: ^19.2.0
- `react-dom`: ^19.2.0
- `chess.js`: ^1.4.0
- `react-chessboard`: ^4.7.3

**Development:**
- `@vitejs/plugin-react`: ^4.3.4
- `typescript`: ~5.9.3
- `vite`: ^7.3.1
- `eslint`: ^9.39.1
- `typescript-eslint`: ^8.19.1
- `eslint-plugin-react-hooks`: ^5.1.0
- `eslint-plugin-react-refresh`: ^0.4.16
- `@dnd-kit/core`: ^6.3.1
- `@dnd-kit/modifiers`: ^9.0.0
- `@types/chess.js`: ^0.13.7
- `react-dnd`: ^16.0.1
- `react-dnd-html5-backend`: ^16.0.1
- `@eslint/js`: ^9.39.1
- `@types/node`: ^24.10.1
- `globals`: ^16.5.0

---

## Правила разработки

### Конвенции кода

1. **TypeScript**:
   - Используется строгий режим (`strict: true`)
   - Все переменные должны иметь явные типы
   - Запрещены неиспользуемые локальные переменные и параметры
   - Используются JSDoc комментарии для функций

2. **React**:
   - Используются функциональные компоненты
   - Хуки для управления состоянием и побочными эффектами
   - JSX: `react-jsx` (новый трансформатор)
   - Компоненты именуются в PascalCase

3. **Стиль кода**:
   - ESLint конфигурация включает рекомендации для JavaScript, TypeScript и React Hooks
   - Используются плагины `react-hooks` и `react-refresh` для Vite
   - Форматирование следует стандарту ESLint

4. **Файловая структура**:
   - Компоненты размещаются в `src/components/`
   - Утилиты и бизнес-логика в `src/utils/`
   - Каждый файл содержит одну сущность (компонент, утилиту, сервис)

### Тестирование

**Текущее состояние**: Тесты не настроены.

**TODO**: Добавить тестовый фреймворк (рекомендуется Vitest для Vite + React Testing Library) и настроить тестирование:
- Unit-тесты для утилит (`fenUtils.ts`)
- Компонентные тесты для React-компонентов
- Интеграционные тесты для проверки функционала

### Контрибьюшн

При добавлении нового кода:
1. Следуйте существующей архитектуре (трехуровневая)
2. Добавляйте JSDoc комментарии к публичным функциям
3. Проверяйте код с помощью `npm run lint`
4. Убедитесь, что TypeScript компилируется без ошибок (`npx tsc --noEmit`)
5. Следуйте плану реализации в `doc/plan.md`

---

## Функциональные возможности

### Реализовано

1. **Отображение шахматной доски**:
   - Использование `react-chessboard`
   - Загрузка позиции из FEN строки
   - Интерактивная доска с перетаскиванием фигур
   - Валидация FEN через `chess.js`

2. **Утилиты для работы с FEN**:
   - `validateFen()`: проверка корректности FEN строки
   - `loadPositionFromFen()`: загрузка позиции из FEN
   - `setInitialPosition()`: установка начальной позиции

3. **Система типов для задач** (`src/types/puzzle.ts`):
   - Полные TypeScript типы для всех типов задач
   - Поддержка типов: `field`, `move`, `sequence`, `lichess`
   - Строгая типизация с discriminated unions

4. **Система типов для статистики** (`src/types/statistics.ts`):
   - Типы для попыток пользователя (`UserAttempt`)
   - Типы для статистики по задаче (`PuzzleStatistics`)
   - Типы для глобальной статистики (`GlobalStatistics`)
   - Типы для статистики по типам задач (`TypeStatistics`)

5. **Сервис работы с localStorage** (`src/services/storageService.ts`):
   - Сохранение попыток пользователя
   - Загрузка всех попыток
   - Очистка всех попыток
   - Очистка попыток по конкретной задаче
   - Версионирование данных для совместимости

6. **Сервис вычисления статистики** (`src/services/statsService.ts`):
   - Вычисление статистики по конкретной задаче
   - Вычисление глобальной статистики
   - Вычисление статистики по типам задач

7. **React хуки для статистики** (`src/hooks/`):
   - `useSaveAttempt()`: сохранение попытки пользователя
   - `useAttempts(puzzleId?)`: получение списка попыток
   - `usePuzzleStats(puzzleId)`: статистика по задаче
   - `useGlobalStats()`: глобальная статистика
   - `useStatsByType()`: статистика по типам задач
   - `useClearAttempts()`: очистка всех попыток
   - `useClearPuzzleAttempts()`: очистка попыток по задаче
   - `StatisticsProvider`: провайдер контекста статистики

8. **Утилиты для работы с задачами** (`src/utils/puzzleUtils.ts`):
   - Валидация FEN, UCI ходов, полей
   - Валидация задач всех типов
   - Валидация коллекций задач
   - Проверка ответов для всех типов задач
   - Конвертация Lichess CSV в формат задач

9. **Формат хранения задач** (`doc/puzzle-format.md`):
   - Полная спецификация JSON-формата для задач
   - Примеры всех типов задач
   - Описание полей и форматов данных
   - Темы и уровни сложности

10. **Формат хранения статистики** (`doc/statistics-format.md`):
    - Спецификация формата хранения в localStorage
    - Описание всех типов статистики
    - Примеры использования хуков
    - Метрики и формулы вычислений

11. **Примеры задач** (`public/puzzles/examples.json`):
    - Примеры задач всех 4 типов
    - Демонстрация всех полей и форматов
    - Включает задачи из Lichess

### В процессе разработки

Согласно плану в `doc/plan.md`:

- **Разработка пользовательского интерфейса** (не начато)

### Запланировано

1. **Пользовательский интерфейс**:
   - Основной экран задач
   - Экран статистики
   - Панель управления (следующая, предыдущая, сброс задачи)
   - Адаптивный дизайн

---

## Ключевые файлы и их назначение

| Файл | Назначение |
|------|------------|
| `package.json` | Зависимости проекта и npm-скрипты |
| `vite.config.ts` | Конфигурация сборщика Vite |
| `tsconfig.json` | Базовая конфигурация TypeScript |
| `tsconfig.app.json` | Конфигурация TypeScript для приложения |
| `eslint.config.js` | Конфигурация линтера |
| `src/main.tsx` | Точка входа в приложение |
| `src/App.tsx` | Главный компонент с шахматной доской |
| `src/utils/fenUtils.ts` | Утилиты для работы с FEN |
| `src/utils/puzzleUtils.ts` | Утилиты для работы с задачами |
| `src/types/puzzle.ts` | TypeScript типы для задач |
| `src/types/statistics.ts` | TypeScript типы для статистики |
| `src/services/storageService.ts` | Сервис работы с localStorage |
| `src/services/statsService.ts` | Сервис вычисления статистики |
| `src/hooks/StatisticsProvider.tsx` | Провайдер контекста статистики |
| `src/hooks/useStatistics.ts` | Публичные хуки статистики |
| `src/index.css` | Глобальные стили приложения |
| `src/App.css` | Стили главного компонента |
| `doc/overview.md` | Обзор проекта |
| `doc/plan.md` | План реализации с статусами |
| `doc/spec.md` | Полная спецификация приложения |
| `doc/puzzle-format.md` | Формат хранения задач |
| `doc/statistics-format.md` | Формат хранения статистики |
| `public/puzzles/examples.json` | Примеры задач всех типов |

---

## Документация

### Основные документы

- **`doc/overview.md`**: Краткий обзор проекта, назначение и технологии
- **`doc/plan.md`**: План реализации с 7 этапами и статусами выполнения
- **`doc/spec.md`**: Полная спецификация, включая архитектуру, функциональные требования, требования к UI

### Спецификация ключевых аспектов

- **Архитектура**: Трехуровневая (Presentation → Business Logic → Data Access)
- **Формат задач**: JSON (полностью определен в `doc/puzzle-format.md`)
- **Хранение данных**: localStorage с возможностью расширения
- **Безопасность**: Без аутентификации, данные хранятся локально
- **Производительность**: Быстрая загрузка, мгновенный отклик UI

---

## Примечания для разработчика

### Текущие ограничения

1. Нет тестов — нужно добавить Vitest и React Testing Library
2. Нет компонента задач — нужно создать UI для решения задач
3. Нет экрана статистики — нужно создать UI для отображения результатов

### Рекомендуемые следующие шаги

1. Создать компонент задачи с логикой проверки ответов
2. Реализовать экран статистики
3. Добавить тесты

### Важные детали реализации

- Используйте `chess.js` для валидации ходов и работы с FEN
- Используйте `react-chessboard` для отображения доски
- Следуйте трехуровневой архитектуре при создании новых модулей
- Добавляйте JSDoc комментарии к функциям
- Проверяйте код линтером и TypeScript перед коммитом

---

## Контакт и поддержка

Проект находится в активной разработке. Вопросы и предложения по улучшению архитектуры следует направлять в документацию (`doc/`) или обсуждать в рамках команды разработки.
